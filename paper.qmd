---
title: "Physical cycling infrastructure and cycling use"
subtitle: "Cross-city associations across 83 European cities"
format: gfm
execute: 
  echo: false
  message: false
  warning: false
  cache: false
---

```{r}
#| label: source-scripts
#| include: false

source("R/00_setup.R")
source("R/01_qol_proxy.R")
source("R/02_city_boundaries.R")
source("R/03_city_metrics.R")
source("R/04_build_city_metrics.R")
source("R/05_join_and_regions.R")
source("R/06_plots.R")
```

## Introduction

- Cycling is widely promoted in European cities to improve public health, reduce emissions, and enhance urban liveability.

- Infrastructure provision is commonly assumed to be a key determinant of cycling uptake.

- However, not all types of cycling infrastructure offer the same level of protection, comfort, or perceived safety.

- Much of the existing evidence relies on single-city case studies or intervention-based evaluations.

- Comparative cross-city analyses that distinguish between infrastructure types remain limited.

- Infrastructure is often measured in aggregate terms, without differentiating between facility composition and quality.

- A harmonised, multi-city assessment can help clarify which physical infrastructure metrics are most strongly associated with cycling levels.

- This is particularly relevant for policy, as cities must decide not only how much infrastructure to build, but what kind.

- **Aim**: To examine how physical cycling infrastructure metrics are associated with city-level cycling use across European cities. 

## Data and methods

### Data sources

We combine three data sources: (i) survey-based cycling use, (ii) city boundaries, and (iii) cycling infrastructure from OSM.

#### Cycling use

Cycling use is measured using the [the EU Quality of Life Survey](https://ec.europa.eu/regional_policy/information-sources/maps/quality-of-life_en) (83 cities; ≈70,000 respondents), which includes the question: “On a typical day, which mode(s) of transport do you use most often?”. Cycling is one of the selectable modes (up to two choices), providing a city-level proxy for cycling prevalence.

#### City boundaries

To ensure comparability, we explored the use of standardized urban boundaries. While administrative boundaries retrieved from OpenStreetMap can vary in geographic extent, methodologies such as the Degree of Urbanisation (DEGURBA), implemented in R packages like `flexurba` and `giscoR`, provide a way to define cities based on population density thresholds (e.g., Urban Centres or Functional Urban Areas). In this preliminary analysis, we use administrative boundaries but apply a clipping heuristic for very large areas (>1000 km²), using a 25 km centroid buffer, and discuss future moves towards using `gisco_get_urban_audit()` for FUA-level analysis.

<!-- This is still an estimation for some cities, can we make this more robust? -->

#### Cycling infrastructure

Cycling infrastructure data were extracted from OpenStreetMap, using the `osmactive` R package. We classified infrastructure into distinct categories using the `classify_cycle_infrastructure` function, which considers OSM tags (e.g., `highway`, `cycleway`, `segregated`) and geometry (e.g., distance to the nearest road) to distinguish between:

  -   **Segregated tracks:** Physically separated from motor traffic (further split into wide $\ge$ 2m and narrow < 2m).
  -   **Off-road paths:** Paths away from the road network (e.g., through parks).
  -   **Painted lanes:** Marked lanes on the carriageway without physical separation.
  -   **Shared footways:** Paths shared with pedestrians.

<!-- -   **Mixed traffic:** Cycling on the carriageway with motor traffic (not counted as dedicated infrastructure). -->

## Results

```{r}
#| label: tbl-qol-cities
#| echo: false
top_3 <- qol_q5 |> head(3)
bottom_3 <- qol_q5 |> tail(3)
middle_rows_indices = 4:(nrow(qol_q5) - 3)
middle_rows <- qol_q5[middle_rows_indices, ]
set.seed(42)
middle_3 <- middle_rows |>
  ungroup() |>
  sample_n(3)

bind_rows(top_3, middle_3, bottom_3) |>
  arrange(desc(bike_prop)) |>
  mutate(bike_prop = scales::percent(bike_prop, accuracy = 0.1)) |>
  select(country, city_name, bike_prop, sample_size = total_sample) |>
  knitr::kable(caption = "Top 3, bottom 3 and 3 random middle cities by cycling levels")
```

```{r}
#| label: fig-scatter-plot
#| fig-cap: "Scatter plots showing the relationship between cycling mode share and different types of cycling infrastructure (as a percentage of the total road network), colored by European region."
knitr::include_graphics("figs/scatter_plot.png")
```

```{r}
#| label: analysis-standardized
#| include: false

standard_analysis <- NULL
cor_standard <- NA_real_

if (file.exists("outputs/city_lengths_standardized.csv")) {
  standard_analysis <- readr::read_csv("outputs/city_lengths_standardized.csv", show_col_types = FALSE) |>
    dplyr::left_join(qol_q5, by = c("country", "city_name")) |>
    dplyr::mutate(
      bike_share_pct = bike_prop * 100,
      pct_segregated = (segregated_km / total_road_km) * 100
    )

  cor_standard <- stats::cor(
    standard_analysis$pct_segregated,
    standard_analysis$bike_share_pct,
    use = "complete.obs"
  )^2
}

n_standard <- if (is.null(standard_analysis)) NA_integer_ else nrow(standard_analysis)

```

The analysis reveals varying degrees of association between infrastructure types and cycling levels when normalized by the total road network.

```{r}
#| label: tbl-correlations
#| tbl-cap: "Correlation between different cycling infrastructure measures and cycling mode share."
cor_data |>
  filter(!str_detect(infra_type_label, "LoS")) |>
  arrange(desc(correlation)) |>
  transmute(
    Metric = infra_type_label,
    `Cities (n)` = n_cities,
    `Correlation (r)` = round(correlation, 3),
    `R-squared` = round(r_squared, 3)
  ) |>
  knitr::kable()
```

Segregated tracks show a strong correlation of $R^2 =$ `r round(r2_vals["Segregated tracks"], 2)`. 

<!-- Surprisingly, the **Low Stress (High/Med LoS)** network shows a weak negative correlation ($r = `r r_vals["Low Stress (High/Med LoS)"]`$). This suggests that a high proportion of low-traffic residential streets does not automatically lead to high cycling levels. In many cases, cities with very high percentages of "low stress" streets are lower-density urban areas where these streets lack the connectivity or dedicated infrastructure on major corridors needed to make cycling a viable transport option across the city. -->

## Discussion

The analysis reveals a clear hierarchy in the relationship between infrastructure types and cycling levels. **Segregated tracks** demonstrate the strongest positive correlation with cycling mode share ($R^2 \approx `r round(r2_vals["Segregated tracks"], 2)`$), supporting the hypothesis that physical separation from motor traffic is the single most important infrastructure feature enabling higher cycling levels.

<!-- The findings for the **Low Stress** network are particularly telling. The lack of a positive correlation suggests that merely "reducing bad infrastructure" (i.e., having many quiet streets) is insufficient for driving modal shift. Successful cycling cities are characterized not just by quiet backstreets, but by high-quality, protected interventions on the main road networks where travel demand is highest. -->

In contrast, **painted lanes** show negligible correlation ($R^2 \approx `r round(r2_vals["Painted lanes"], 2)`$), reinforcing the growing consensus that markings without protection are insufficient to encourage significant increases in cycling.

Other facility types, such as **off-road paths** and **shared footways**, display more modest associations with cycling levels. While these facilities may contribute to local connectivity or recreational cycling, they do not exhibit the same strong relationship with city-wide cycling mode share as segregated tracks.

### Limitations

<!-- -   **Data Completeness:** Data retrieval was successful for `r sum(!is.na(qol_city_metrics[["total_road_km"]]))` out of `r nrow(qol_city_metrics)` cities.  -->
-   **OSM Quality:** The analysis relies on OpenStreetMap data completeness and tagging consistency, which varies by region.
-   **Causality:** This cross-sectional analysis establishes correlation, not causality. High cycling levels might drive investment in infrastructure, or vice versa.

## Conclusion

Our findings suggest that cities aiming to increase cycling mode share should prioritize the development of **segregated cycling infrastructure**. While paint and shared paths provide connectivity, they do not show the same strong relationship with high cycling usage observed for physically separated tracks. 

Future research should extend this infrastructure-based approach by incorporating network connectivity metrics (e.g., directness, mesh density, network continuity) to assess not only the quantity but also the structural coherence of cycling infrastructure. 

A complementary extension would integrate traffic-stress measures (e.g., Level of Service classifications) to jointly examine infrastructure provision and cycling conditions. 

Finally, multivariate models including urban density, land-use mix, topography, and climate would help disentangle infrastructure effects from broader structural determinants of cycling.

<!-- ### Standardized vs. Administrative Boundaries -->

<!-- Preliminary testing with standardized Urban Centre boundaries (derived from the `giscoR` implementation of DEGURBA/flexurba definitions) for `r nrow(standard_analysis)` cities shows a correlation ($R^2$) for segregated infrastructure of `r round(cor_standard, 2)`. This suggests that the signal is robust across different boundary definitions, though standardized boundaries often yield lower total road lengths by excluding low-density suburban peripheries. -->

<!-- ## Next steps -->

<!-- -   Investigate missing data for France and Spain. -->
<!-- -   Expand metrics to include network connectivity (e.g., mesh density, directness). -->
<!-- -   Fit multivariate regression models including controls. -->